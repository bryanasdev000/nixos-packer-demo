{
  "variables":{
    "project_id":"{{env `GCP_PROJECT_ID`}}",
    "gcp_service_account_file":"{{env `GCP_SERVICE_ACCOUNT_FILE`}}",
    "ssh_priv_key":"{{env `SSH_PRIV_KEY`}}",
    "build":"{{env `BUILD_NUMBER`}}"
  },
  "builders":[
    {
      "type":"googlecompute",
      "account_file":"{{user `gcp_service_account_file`}}",
      "project_id":"{{user `project_id`}}",
      "source_image":"nixos-20-03-prepared",
      "ssh_username":"packer",
      "ssh_private_key_file":"{{user `ssh_priv_key`}}",
      "zone":"southamerica-east1-a",
      "image_name":"nixos-20-03-packer-web-{{user `build`}}",
      "use_os_login":"false",
      "disk_size": "40"
    }
  ],
  "provisioners":[
    {
      "type":"file",
      "source":"configuration_web.nix",
      "destination":"/tmp/configuration.nix"
    },
    {
      "type":"shell",
      "inline":[
        "sleep 15",
        "sudo cp /tmp/configuration.nix /etc/nixos/configuration.nix",
        "sudo nixos-rebuild switch --upgrade",
        "sudo nix-collect-garbage --delete-older-than 1d",
        "sudo nix-store --optimise"
      ]
    }
  ]
}
